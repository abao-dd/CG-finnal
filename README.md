# CG期末项目报告

## Introduction

一个控制人物走迷宫的游戏。

渲染物体：天空盒，岛屿，人物，迷宫，灯

整个程序是一个状态机，包括。。。

走迷宫时，一共有两次渲染，先渲染阴影，再渲染物体。摄像机和人物一起移动。

## maze 生成

迷宫的一个 cell 由中心通路和四面墙组成，呈十字状。

采用 Prim 算法，把 cell 看成顶点，生成迷宫的通路就是生成树。

cell 的状态有3种，状态为1的 cell 是树的顶点，状态为2的 cell 是非树顶点中树顶点的周围顶点，也就是可以考虑加入树的顶点，状态为0的 cell 是剩余顶点。打通的意思就是将顶点连入树中。

一个 cell 有5个属性：cell 的状态，四面墙是否被打破。

未加入过 list 的 cell 状态为0，从 list 中删除的 cell 状态为1，在 list 中的 cell 的状态为2。

将一个 cell 加入 list。当 list 不为空，从 list 中随机选一个cell，删除，考虑周围状态为1的 cell 的方向，随机选一个方向打通，将它周围所有状态为0的 cell 加入 list。

为了好看，将墙扩展为8面，也就是说，一个 cell 是一个3乘3的矩阵，通路在中心。

为了渲染，我们需要记录通路的位置于 maze_map，记为 true。迷宫固定入口和出口，需要将对应的墙打通。

## maze 的渲染

用立方体来渲染每一面墙，为了让通路更加宽敞，墙的大小可以调整，主要有三种，记录在 cubeScales。

判断每个 cell 的9个格子，maze_map 是 false 的就需要渲染一面墙，将墙的位置记录在 cubePositions。每面墙的位置在 cell 中相对固定，主要就是求 cell 的位置。

渲染时，根据 maze_map 的值，在相应位置，渲染相应大小的墙。最后还会渲染一个地板。

## 人物和 maze 的碰撞

给人物加一个立方体包围盒，在移动人物时，要防止包围盒和墙发生碰撞。

由于人物不会发生上下翻转，只会在平面上平移和旋转，只需要考虑立方体的底面不会和墙的底面发生碰撞即可。也就是说，我们只需要考虑两个矩形的碰撞即可。

两个矩形发生碰撞，当且仅当两个矩形的边发生了碰撞。所以需要考虑两个线段发生碰撞。

线段(a1,a2)，(b1,b2)相交，等价于a1，a2在(b1,b2)两侧且b1，b2在(a1,a2)两侧。

a1，a2在(b1,b2)两侧，等价于$((b1,a1)\times(b1,b2))*((b1,a2)\times(b1,b2))<0$

b1，b2在(a1,a2)两侧，等价于$((a1,b1)\times(a1,a2))*((a1,b2)\times(a1,a2))<0$

由于迷宫位于同一高度，只需要考虑 $x-z$ 平面，根据二维向量叉乘，$a\times b=(a_z*b_x-a_x*b_z)\overline{e}$

$(b1a1_z*b1b2_x-b1a1_x*b1b2_z)*(b1a2_z*b1b2_x-b1a2_x*b1b2_z)<0$

$(a1b1_z*a1a2_x-a1b1_x*a1a2_z)*(a1b2_z*a1a2_x-a1b2_x*a1a2_z)<0$

现在考虑人物和 maze 的碰撞，由于我们知道人物的位置，所以不需要考虑人物与所有墙的碰撞。

通过人物的位置可以定位人物在迷宫的哪一个 cell，然后我们考虑以这个 cell 为中心的9个 cell 的墙是否与人物发生碰撞即可。

## BGM

使用mciSendString来控制音乐的播放

## 待改进

小苹果，小地图，人物肢体移动，三维空间的迷宫
