# CG期末项目报告

## Introduction

一个控制人物走迷宫的游戏。

渲染物体：天空盒，岛屿，人物，迷宫，灯

整个程序是一个状态机，包括。。。

走迷宫时，一共有两次渲染，先渲染阴影，再渲染物体。摄像机和人物一起移动。

## maze 生成

迷宫的一个 cell 由中心通路和四面墙组成，呈十字状。

采用 Prim 算法，把 cell 看成顶点，生成迷宫的通路就是生成树。

cell 的状态有3种，状态为1的 cell 是树的顶点，状态为2的 cell 是非树顶点中树顶点的周围顶点，也就是可以考虑加入树的顶点，状态为0的 cell 是剩余顶点。打通的意思就是将顶点连入树中。

一个 cell 有5个属性：cell 的状态，四面墙是否被打破。

未加入过 list 的 cell 状态为0，从 list 中删除的 cell 状态为1，在 list 中的 cell 的状态为2。

将一个 cell 加入 list。当 list 不为空，从 list 中随机选一个cell，删除，考虑周围状态为1的 cell 的方向，随机选一个方向打通，将它周围所有状态为0的 cell 加入 list。

为了好看，将墙扩展为8面，也就是说，一个 cell 是一个3乘3的矩阵，通路在中心。

为了渲染，我们需要记录通路的位置于 maze_map，记为 true。迷宫固定入口和出口，需要将对应的墙打通。

## maze 的渲染

用立方体来渲染每一面墙，为了让通路更加宽敞，墙的大小可以调整，主要有三种，记录在 cubeScales。

判断每个 cell 的9个格子，maze_map 是 false 的就需要渲染一面墙，将墙的位置记录在 cubePositions。每面墙的位置在 cell 中相对固定，主要就是求 cell 的位置。

渲染时，根据 maze_map 的值，在相应位置，渲染相应大小的墙。最后还会渲染一个地板。

## 人物和 maze 的碰撞

给人物加一个立方体包围盒，在移动人物时，要防止包围盒和墙发生碰撞。

由于人物不会发生上下翻转，只会在平面上平移和旋转，只需要考虑立方体的底面不会和墙的底面发生碰撞即可。也就是说，我们只需要考虑两个矩形的碰撞即可。

两个矩形发生碰撞，当且仅当两个矩形的边发生了碰撞。所以需要考虑两个线段发生碰撞。

线段(a1,a2)，(b1,b2)相交，等价于a1，a2在(b1,b2)两侧且b1，b2在(a1,a2)两侧。

a1，a2在(b1,b2)两侧，等价于$((b1,a1)\times(b1,b2))*((b1,a2)\times(b1,b2))<0$

b1，b2在(a1,a2)两侧，等价于$((a1,b1)\times(a1,a2))*((a1,b2)\times(a1,a2))<0$

由于迷宫位于同一高度，只需要考虑 $x-z$ 平面，根据二维向量叉乘，$a\times b=(a_z*b_x-a_x*b_z)\overline{e}$

$(b1a1_z*b1b2_x-b1a1_x*b1b2_z)*(b1a2_z*b1b2_x-b1a2_x*b1b2_z)<0$

$(a1b1_z*a1a2_x-a1b1_x*a1a2_z)*(a1b2_z*a1a2_x-a1b2_x*a1a2_z)<0$

现在考虑人物和 maze 的碰撞，由于我们知道人物的位置，所以不需要考虑人物与所有墙的碰撞。

通过人物的位置可以定位人物在迷宫的哪一个 cell，然后我们考虑以这个 cell 为中心的9个 cell 的墙是否与人物发生碰撞即可。

## BGM

使用mciSendString来控制音乐的播放

## 天空盒背景

参考：opengl立方体贴图部分

​		天空盒是一个覆盖场景四周的长方体，但它的各个面上贴有表示天空的纹理图片，即四周的4面纹理的边与顶面纹理的边相连，同时四面纹理前后相连。

​		本项目采用了如下的天空盒模型，以right，left，top，bottom，front，back的顺序为盒子添加纹理。

![](D:\project\CG-final\code\textures\skybox\all.jpg)

## 光照

环境光Ambient：

​		定义：是由光源发出经环境多次散射而无法确定其入射方向的光，即似乎来自所有方向。其特征是入射方向和出射方向均为任意方向。

​		项目用途：本项目通过添加环境光的方式来增强场景的亮度，使得场景具备一部分的初始亮度。

漫反射Diffuse：

​		定义：来自特定方向，它垂直于物体时比倾斜时更明亮。一旦它照射到物体上，则在各个方向上均匀地发散出去，效果为无论视点在哪里它都一样亮，其特征是入射方向唯一、出射方向为任意方。

​		项目用途：漫反射使物体上与光线方向越接近的片段能从光源处获得更多的亮度，因此能够使得添加光源后达到逼真的效果。

镜面光Specular：

​		定义：来自特定方向并沿另一方向反射出去，一个平行激光束在高质量的镜面上产生100%的镜面反射，其特征是入射方向和出射方向均唯一

​		项目用途：会在光源打到物体身上时达到一个高光的效果。

## 光源

平行光源：

​	平行光源只有光照方向，没有光源位置，且在传播过程中默认没有衰减。项目中通过添加平行光源来模拟太阳光照的效果。

点光源：

​	点光源既有光照方向，又有光源位置，且在传播过程汇总存在光照强度随距离衰减的现象。项目中在迷宫上方制作了一个白色正方体充当光源，并且该正方体随时间增长而进行圆周运动，起到移动光源的作用，并对场景的渲染产生了更好的效果。

## 阴影

两次渲染：分别从光源和视口角度渲染场景。

- 第一次渲染：把相机放到光源位置渲染场景，然后存储渲染的深度信息到一张纹理上，即深度贴图。

- 第二次渲染：从观察者的角度来渲染场景，在这次渲染时才渲染阴影，这次的渲染过程本质就是纹理贴图，只不过这个纹理是阴影图，贴图的方式根据我们设置的深度纹理过滤方式处理。生成阴影的过程是这样的：对于每个片元的深度信息和第一次从灯光角度渲染的深度信息比较，如果当前深度值大于第一次渲染的深度值，则肯定有物体在当前片元和灯光之间，那么当前片元在阴影区；否则，当前片元不在阴影区。

解决阴影失真问题：阴影贴图受限于分辨率，在距离光源比较远的情况下，多个片段可能从深度贴图的同一个值中去采样，因此放大阴影会看到明显的线条形式。此时使用一个阴影偏移量bias可以解决该问题，即简单的对表面的深度应用一个偏移量，这样片段就不会被错误地认为在表面之下了。

解决锯齿边问题：因为深度贴图有一个固定的分辨率，多个片段对应于一个纹理像素。结果就是多个片段会从深度贴图的同一个深度值进行采样，这几个片段便得到的是同一个阴影，这就会产生锯齿边。通过实现PCF即从纹理像素四周对深度贴图采样，然后把结果平均起来可以达到平滑锯齿边，得到柔和阴影的效果。

## 待改进

小苹果，小地图，人物肢体移动，三维空间的迷宫
